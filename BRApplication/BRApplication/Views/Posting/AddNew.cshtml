@model IEnumerable<BRApplication.Models.Textbook>

<style type="text/css">
    /*Tooltip component by www.menucool.com */

    /*For tooltip target element that has set class="tooltip" */
    .tooltip {text-decoration: none; border-bottom:0px dotted #36c; outline: none; }

    /*For tooltip box*/
    div#mcTooltip 
    {
        line-height:16px;
        border-width: 1px;   
        color:#333; 
        border-color:#BBBBBB;
        padding:20px;
        font-size: 12px;
        font-family: Verdana, Arial;
        border-radius:6px; /*Rounded corners. N/A for IE 8 and below.*/
        box-shadow: 0 1px 4px #AAAAAA; /*Drop shadow. N/A for IE 8 and below.*/
    }

    div#mcTooltip, div.mcTooltipInner 
    {
        background-color:#FFFFFF;
    }

    /* For hyperlink within tooltip */
    div#mcTooltip a { 
        color:#36c; 
    }

    /*Close button. Only available when sticky or overlay has been set to true.*/
    div#mcttCloseButton 
    {
        width:14px;
        height:14px;
        position:absolute;
        background-image:url(closeBtn.gif);
        cursor:pointer; 
        overflow:hidden;
        top:12px; 
        right:12px; 
        left:auto;
    }            

    /* Only applies when overlay has been set to true or 1.*/
    div#mcOverlay 
    {
        background-color: white;
        opacity:0.8; 
        filter: alpha(opacity=80); 
        display:none;
        top:0;left:0;
        width:100%;
        height: 100%;
        overflow:visible;
        z-index:4; 
    }

    /*Only available when calling by tooltip.ajax(...). It will be a spinning image indicating a request is in progress.*/
    div#tooltipAjaxSpin {
        margin:20px 50px; 
        background:transparent url(loading.gif) no-repeat center center; 
        width:50px; 
        height:30px; 
        font-size:0;

    }

    /*The settings below should remain unchanged*/
    div#mcTooltipWrapper {
        position:absolute;
        visibility:hidden;
        overflow:visible;
        z-index:9999999999;
        top:-2000px;

    }
    div#mcTooltip {
        float:left;
        border-style:solid;
        position:relative;
        overflow:hidden;
    }
    div.mcTooltipInner {
        float:left;
        position:relative;
        width:auto;
        height:auto;
    }
    div#mcttCo {
        position:absolute;
        text-align:left;
    }
    div#mcttCo em, div#mcttCo b {
        display:block;
        width:0; 
        height:0;
        overflow:hidden;
    }

    #SubmitDialog {
        display:none;
    }
    #ErrorDialog {
        display:none;
    }

    .ContactPref {
        width:100%;
    }

    .PrefDetail ul {
        width:100%;
        display:inline-block; 
        padding:0px; 
    }
    .PrefDetail ul li {
        display:inline-block;
        list-style-type:none;
        padding:0px; 
    }

    .lblContactRef {
        width:20%;
        padding:0px;
        font-weight:bold;
        float: left;
    }
    .valContactRef {
        width:80%;
        padding:0px;
        float: left;
    }

</style>

<div id="SubmitDialog" title="Contact Preference">
    <div id="ContactPref">
        <div class="PrefDetail">
            <ul>
                <li class="lblContactRef">Email</li>
                <li class="valContactRef">This will be kept private. BookSpade will send you an email with the contact of those interested.</li>
            </ul>
        </div>
        <div class="PrefDetail">
            <ul>
                <li class="lblContactRef">Facebook</li>
                <li class="valContactRef">A profile link will be displayed to everyone interested in responding to your post.</li>
            </ul>
        </div>
    </div>

    <div>
        @Html.RadioButton("Pref", false)Facebook
        @Html.RadioButton("Pref", true)Email
    </div>
    <div id="divContactEmail" style="display:none;">
        Please enter a valid email: 
        @Html.TextBox("txtContactEmail")
    </div>
</div>

<div>

</div>
<div id="ErrorDialog" title="Oops!"> Please select a book or add you own book</div>


<div class="PostContainer">
    <div class="NewPost">
        <div class="PostHeader">
            <img src="@Url.Content("~/Content/Images/BookStack.png")" alt="BookStack"/>&nbsp
            Add Your Posting
        </div>
        <div class="SearchBook">
            @Html.TextBox("txtSearchBook")
            <input id="SearchButton" type="button" value="Search" />
        </div>
        
        <div class="ChooseBook">
            <div id="BookListWrapper">
                
                <ul id="BookList" class="SearchResults wave">
                    
                    @for (int i = 0; i < @Model.Count(); i++)
                    { 
                        <li class="tooltip" onmouseover="tooltip.pop(this, '<span style=\'color:black;\'><div style=\'float:left;\'><img src=\'@Model.ElementAt(i).BookImageURL\' width=\'100px\' /></div><div style=\'float:left;\'>ISBN: @Model.ElementAt(i).ISBN<br />Book Title: @Model.ElementAt(i).Title<br />Author(s): @Model.ElementAt(i).Author<br />Course: @Model.ElementAt(i).CourseName<br />Store Price: &#36;@Model.ElementAt(i).StorePrice</div></span>')">
                            <div class="item">
                                <span id="Course" class="Block">@Model.ElementAt(i).CourseName</span>
                                <span id="Title" class="Block Truncate One-line">@Model.ElementAt(i).Title</span>
                            </div>
                        </li>
                    }
                </ul>
            </div>
            <a class="link">Cannot find your book? Click Here</a>
        </div>
    </div>
    <div class="hidden">
        @Html.Partial("AddBook_Partial");
    </div>
</div>
<div class="AddPost">
    <input id="Price" class="InputGradient Info" type="text" placeholder="Price ($)" />
    <input id="SubmitButton" type="button" value="Add Post" />
</div>
<div class="PostType">
    <select id="PostType">
        <option value="Buy" selected>Buy</option>
        <option value="Sell">Sell</option>
    </select>
    <input id="Condition" class="InputGradient Info" type="text" placeholder="Condition" />
</div>

@* Must come after definition of the 'ul' element that we are binding to*@
<script type="text/javascript">
    stroll.bind('.NewPost ul');
    
    $("li").click(function () {
        $(this).siblings(".selected").removeClass("selected");
        $(this).addClass("selected");
    });

    // get the width of the book list minus scrollbar
    var bookList = document.getElementById("BookList");
    var origWidth = bookList.offsetWidth;
    var scrollWidth = bookList.scrollWidth;

    // width of our wrapper equals width of the scrollable part of the book list
    document.getElementById("BookListWrapper").style.width = scrollWidth + "px";
    bookList.style.width = origWidth + "px";

    var addBook = false;

    $(".link").click(function () {
        addBook = !addBook;

        var origHeight = $(".NewPost").css("height");

        if (addBook) {
            $(".hidden").show();
            $(".NewPost").css("height", origHeight);
        } else {
            $(".hidden").hide();
            $(".NewPost").css("height", "92%");
        }
    });

</script>


@section scripts {
    <script src="@Url.Content("~/Scripts/ToolTip.js")" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $(":radio[name=Pref]").change(function () {
                if ($(this).val() == 'True') {
                    $("#divContactEmail").show(); 
                } else {
                    $("#divContactEmail").val("");
                    $("#divContactEmail").hide();
                }
            });

            $("#SubmitButton").click(function () {
                if (!$("li.selected").length && !addBook) {
                    ErrorDialog();
                } else {
                    ContactPrefDialog();
                }
            });
        });


        function CommonFields() {

            var isBuy = $("#PostType").val() == "Buy";
            var price = $("#Price").val().trim();
            var condition = $("#Condition").val().trim();
            var email = $("#txtContactEmail").val();

            alert(email); 

            var fields = {
                "isBuy": isBuy,
                "price": price,
                "condition": condition,
                "email": email
            }
            return fields;
        }

        function ErrorDialog() {
            $("#ErrorDialog").dialog({
                height: 200,
                width: 500,
                modal: true,
                buttons: {
                    "OK" : function () {
                        $(this).dialog("close"); 
                    }
                }
            }); 
        }

        function ContactPrefDialog() {
            $("#SubmitDialog").dialog({
                height: 500,
                width: 500,
                modal: true,
                buttons: {
                    "Post" : function () {
                        if (addBook) {
                            NewBook();
                            $(this).dialog("close");
                        } else {
                            AddPost();
                            $(this).dialog("close");
                       }
                    },
                    "Cancel": function () {
                        $(this).dialog("close"); 
                    }
                }
            });
        }

        function AddPost() {
            var course = $("li.selected #Course").text().trim();
            var title = $("li.selected #Title").text().trim();
            var common = CommonFields(); 

            $.ajax({
                url: '@Url.Action("SavePost", "Posting")',
                    data: {
                        profileID: 0,
                        course : course,
                        title : title,
                        isBuy : common.isBuy,
                        price : common.price,
                        condition : common.condition,
                        email : common.email
                    },
                    type: 'POST',
                    success: function (result) {
                        // TODO: do something with success
                    }
                });
        }

        function NewBook() {
            var title = $(".NewBook #Title").val().trim();
            var author = $(".NewBook #Author").val().trim();
            var course = $(".NewBook #Course").val().trim();
            var isbn = $(".NewBook #ISBN").val().trim();
            var bookImageURL = $(".NewBook #BookImageURL").val().trim();
            var common = CommonFields();

            $.ajax({
                url: '@Url.Action("SaveBook", "Posting")',
                data: {
                    isbn : isbn,
                    title : title,
                    author : author,
                    course : course,
                    bookImageURL : bookImageURL,
                    isBuy : common.isBuy,
                    price : common.price,
                    condition : common.condition,
                    email : common.email
                },
                type: 'POST',
                success: function (result) {
                    // TODO: do something with success
                }
            });
        }
    </script> 
   
}
